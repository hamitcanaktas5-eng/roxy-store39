<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Bakiye Ekle - Roxy Store</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap');
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
:root{--p:#00D9FF;--s:#A855F7;--g:#00FF88;--dark:#0A0A0F;--d2:#12121A;--d3:#1A1A28;--border:rgba(0,217,255,.12);--muted:#A0A0B8;--err:#FF6584;--warn:#FFB347;}
body{font-family:'Poppins',sans-serif;background:var(--dark);color:#fff;overflow-x:hidden;}
.sidebar{position:fixed;left:-280px;top:0;width:270px;height:100vh;background:rgba(26,26,40,.98);backdrop-filter:blur(24px);border-right:1px solid var(--border);z-index:1000;transition:left .3s;display:flex;flex-direction:column;}
.sidebar.open{left:0;}
.sb-head{padding:22px 20px;border-bottom:1px solid rgba(255,255,255,.05);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.logo{display:flex;align-items:center;gap:12px;}
.logo-icon{width:42px;height:42px;background:linear-gradient(135deg,var(--p),var(--s));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;color:#0A0A0F;}
.logo-main{font-size:22px;font-weight:900;background:linear-gradient(135deg,var(--p),var(--s));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.logo-sub{font-size:10px;font-weight:600;color:var(--muted);letter-spacing:2px;display:block;}
.sb-close{background:transparent;border:none;color:var(--muted);font-size:22px;cursor:pointer;padding:6px;}
.sb-nav{flex:1;overflow-y:auto;padding:12px 0;}
.nav-item{display:flex;align-items:center;gap:12px;padding:13px 20px;color:var(--muted);text-decoration:none;border-left:3px solid transparent;font-size:14px;font-weight:500;transition:.2s;cursor:pointer;}
.nav-item:hover,.nav-item.active{background:rgba(0,217,255,.07);color:var(--p);border-left-color:var(--p);}
.nav-item i{width:20px;font-size:17px;text-align:center;}
.nav-sep{height:1px;background:rgba(255,255,255,.06);margin:8px 16px;}
.nav-item.support{color:var(--p);font-weight:700;}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:999;opacity:0;visibility:hidden;transition:.3s;}
.overlay.active{opacity:1;visibility:visible;}
.main{min-height:100vh;display:flex;flex-direction:column;}
.topbar{background:rgba(26,26,40,.98);backdrop-filter:blur(24px);border-bottom:1px solid var(--border);padding:0 24px;height:68px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;}
.tb-left{display:flex;align-items:center;gap:14px;}
.menu-btn{background:transparent;border:none;color:#fff;font-size:22px;cursor:pointer;padding:8px;}
.tb-logo-text{font-size:18px;font-weight:900;background:linear-gradient(135deg,var(--p),var(--s));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.tb-logo-sub{font-size:10px;color:var(--muted);letter-spacing:1.5px;font-weight:600;}
.tb-right{display:flex;align-items:center;gap:14px;}
.bal-box{display:flex;align-items:center;gap:10px;padding:9px 14px;background:rgba(0,217,255,.07);border:1.5px solid rgba(0,217,255,.2);border-radius:12px;cursor:pointer;transition:.2s;}
.bal-box:hover{border-color:var(--p);}
.bal-box i{color:var(--p);font-size:18px;}
.bal-label{font-size:10px;color:var(--muted);display:block;text-transform:uppercase;letter-spacing:.5px;}
.bal-amount{font-size:15px;font-weight:800;color:var(--p);}
.user-box{display:flex;align-items:center;gap:8px;cursor:pointer;}
.user-box img{width:38px;height:38px;border-radius:50%;border:2px solid var(--p);}
.user-box span{font-weight:600;font-size:14px;}
.content{flex:1;max-width:720px;width:100%;margin:0 auto;padding:36px 24px 60px;}
.page-hd{margin-bottom:28px;}
.page-hd h1{font-size:26px;font-weight:900;display:flex;align-items:center;gap:10px;margin-bottom:6px;}
.page-hd h1 i{color:var(--p);}
.page-hd p{color:var(--muted);}
/* Y√ñNTEM KARTLARI */
.methods{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:24px;}
.method-card{background:var(--d3);border:1.5px solid var(--border);border-radius:18px;padding:24px 20px;cursor:pointer;transition:.2s;position:relative;text-align:center;}
.method-card:hover{border-color:rgba(0,217,255,.3);transform:translateY(-2px);}
.method-card.selected{border-color:var(--p);background:rgba(0,217,255,.07);}
.method-card.maintenance{opacity:.6;cursor:not-allowed;}
.method-card.maintenance:hover{transform:none;border-color:var(--border);}
.method-badge{position:absolute;top:12px;right:12px;padding:4px 8px;border-radius:6px;font-size:10px;font-weight:700;}
.badge-maint{background:rgba(255,179,71,.2);color:var(--warn);}
.badge-manual{background:rgba(0,217,255,.15);color:var(--p);}
.method-icon{font-size:32px;margin-bottom:10px;}
.method-icon.blue{color:var(--p);}
.method-icon.purple{color:var(--s);}
.method-title{font-size:15px;font-weight:700;margin-bottom:6px;}
.method-desc{font-size:12px;color:var(--muted);}
/* FORM */
.card{background:var(--d3);border:1.5px solid var(--border);border-radius:20px;padding:28px;margin-bottom:18px;display:none;}
.card.show{display:block;}
.card-title{font-size:17px;font-weight:800;display:flex;align-items:center;gap:10px;margin-bottom:22px;}
.card-title i{color:var(--p);}
/* IBAN DETAY */
.iban-box{background:var(--d2);border:1.5px solid var(--border);border-radius:14px;padding:20px;margin-bottom:20px;}
.iban-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.04);}
.iban-row:last-child{border-bottom:none;}
.iban-label{font-size:12px;color:var(--muted);font-weight:600;}
.iban-val{font-size:14px;font-weight:700;display:flex;align-items:center;gap:10px;}
.copy-btn{background:rgba(0,217,255,.1);border:1px solid rgba(0,217,255,.2);border-radius:8px;color:var(--p);cursor:pointer;padding:6px 10px;font-size:12px;font-family:'Poppins',sans-serif;transition:.2s;}
.copy-btn:hover{background:rgba(0,217,255,.2);}
.sec-note{background:rgba(0,217,255,.05);border:1px solid rgba(0,217,255,.1);border-radius:10px;padding:12px 14px;font-size:12px;color:var(--muted);display:flex;align-items:flex-start;gap:8px;margin-bottom:20px;}
.sec-note i{color:var(--p);flex-shrink:0;margin-top:1px;}
/* Field */
.field{margin-bottom:18px;}
.field-label{font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:flex;align-items:center;gap:8px;margin-bottom:10px;}
.field-label i{color:var(--p);}
.field-hint{font-size:11px;color:var(--muted);margin-top:5px;}
.inp{width:100%;padding:14px 16px;background:var(--d2);border:1.5px solid rgba(255,255,255,.08);border-radius:12px;color:#fff;font-family:'Poppins',sans-serif;font-size:14px;outline:none;transition:border .2s;}
.inp:focus{border-color:var(--p);}
/* SCHED */
.sched{display:flex;align-items:flex-start;gap:14px;padding:16px 18px;border-radius:14px;margin-bottom:20px;}
.sched.ok{background:rgba(0,255,136,.07);border:1.5px solid rgba(0,255,136,.25);}
.sched.off{background:rgba(168,85,247,.07);border:1.5px solid rgba(168,85,247,.25);}
.sched-ico{font-size:24px;flex-shrink:0;}
.sched.ok .sched-ico{color:var(--g);}
.sched.off .sched-ico{color:var(--s);}
.sched h4{font-size:13px;font-weight:700;margin-bottom:3px;}
.sched p{font-size:12px;color:var(--muted);line-height:1.6;}
/* BTN */
.btn-pay{width:100%;display:flex;align-items:center;justify-content:center;gap:12px;padding:17px;background:linear-gradient(135deg,var(--p),var(--s));border:none;border-radius:14px;color:#0A0A0F;font-family:'Poppins',sans-serif;font-weight:800;font-size:16px;cursor:pointer;transition:.2s;margin-top:4px;}
.btn-pay:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 14px 40px rgba(0,217,255,.4);}
.btn-pay:disabled{opacity:.35;cursor:not-allowed;}
/* GE√áMƒ∞≈û */
.hist-title{font-size:18px;font-weight:800;margin-bottom:16px;display:flex;align-items:center;gap:10px;}
.hist-title i{color:var(--p);}
.hist-box{background:var(--d3);border:1.5px solid var(--border);border-radius:18px;overflow:hidden;}
.hist-row{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.04);}
.hist-row:last-child{border-bottom:none;}
.hist-empty{text-align:center;padding:40px;color:var(--muted);}
.hist-empty i{font-size:36px;opacity:.25;display:block;margin-bottom:12px;}
footer{background:var(--d3);border-top:1px solid var(--border);padding:22px 24px;margin-top:auto;}
.foot-in{max-width:720px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;}
.foot-links{display:flex;gap:10px;}
.foot-link{display:flex;align-items:center;gap:6px;padding:8px 14px;border-radius:8px;text-decoration:none;font-size:13px;font-weight:600;color:#fff;}
.foot-link.wa{background:#25D366;}.foot-link.tg{background:#0088CC;}
.foot-copy{color:var(--muted);font-size:13px;}
@media(max-width:768px){.user-box span,.bal-label{display:none;}.content{padding:20px 14px;}.methods{grid-template-columns:1fr;}}
</style>
</head>
<body>

<div class="sidebar" id="sidebar">
  <div class="sb-head">
    <div class="logo"><div class="logo-icon"><i class="fas fa-bolt"></i></div><div><span class="logo-main">ROXY</span><span class="logo-sub">STORE</span></div></div>
    <button class="sb-close" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
  </div>
  <nav class="sb-nav">
    <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i><span>Ana Sayfa</span></a>
    <a href="virtual-number.html" class="nav-item"><i class="fas fa-mobile-alt"></i><span>Sanal Numara</span></a>
    <a href="social-media.html" class="nav-item"><i class="fas fa-chart-line"></i><span>Sosyal Medya</span></a>
    <a href="balance.html" class="nav-item active"><i class="fas fa-wallet"></i><span>Bakiye Ekle</span></a>
    <a href="reviews.html" class="nav-item"><i class="fas fa-star"></i><span>Deƒüerlendirmeler</span></a>
    <div class="nav-sep"></div>
    <a href="support.html" class="nav-item support"><i class="fas fa-headset"></i><span>Destek</span></a>
    <a href="profile.html" class="nav-item"><i class="fas fa-user-circle"></i><span>Profil</span></a>
    <div class="nav-item" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i><span>√áƒ±kƒ±≈ü Yap</span></div>
  </nav>
</div>
<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

<div class="main">
  <div class="topbar">
    <div class="tb-left">
      <button class="menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
      <div><span class="tb-logo-text">ROXY</span> <span class="tb-logo-sub">STORE</span></div>
    </div>
    <div class="tb-right">
      <div class="bal-box" onclick="window.location.href='balance.html'" title="Bakiye Ekle">
        <i class="fas fa-wallet"></i>
        <div><span class="bal-label">Bakiye</span><span class="bal-amount" id="balDisplay">0 ‚Ç∫</span></div>
      </div>
      <div class="user-box" onclick="window.location.href='profile.html'">
        <img id="userAvatar" src="https://ui-avatars.com/api/?name=U&background=00D9FF&color=fff" alt="">
        <span id="userName">Kullanƒ±cƒ±</span>
      </div>
    </div>
  </div>

  <div class="content">
    <div class="page-hd">
      <h1><i class="fas fa-wallet"></i> Bakiye Ekle</h1>
      <p>Hesabƒ±nƒ±za bakiye y√ºkleyin</p>
    </div>

    <!-- Y√ñNTEM KARTLARI -->
    <div class="methods">
      <div class="method-card maintenance">
        <span class="method-badge badge-maint">üîß Bakƒ±mda</span>
        <div class="method-icon blue"><i class="fas fa-credit-card"></i></div>
        <div class="method-title">√ñdeme Saƒülayƒ±cƒ±</div>
        <div class="method-desc">Yakƒ±nda aktif olacak</div>
      </div>
      <div class="method-card" id="paparaCard" onclick="selectPapara()">
        <span class="method-badge badge-manual">Manuel Onay</span>
        <div class="method-icon purple"><i class="fas fa-university"></i></div>
        <div class="method-title">Papara Transferi</div>
        <div class="method-desc">IBAN ile havale yapƒ±n</div>
      </div>
    </div>

    <!-- PAPARA FORMU -->
    <div class="card" id="paparaForm">
      <div class="card-title"><i class="fas fa-university"></i> Papara Transferi</div>

      <!-- Mesai -->
      <div class="sched" id="schedBox">
        <div class="sched-ico" id="schedIco"></div>
        <div><h4 id="schedTitle"></h4><p id="schedText"></p></div>
      </div>

      <!-- IBAN Bƒ∞LGƒ∞LERƒ∞ -->
      <div class="iban-box">
        <div class="iban-row">
          <span class="iban-label">Alƒ±cƒ± Adƒ±</span>
          <span class="iban-val">Papara A.≈û. <button class="copy-btn" onclick="copyText('Papara A.≈û.')"><i class="fas fa-copy"></i></button></span>
        </div>
        <div class="iban-row">
          <span class="iban-label">IBAN</span>
          <span class="iban-val" style="font-size:13px;">TR93 0082 9000 0949 1708 3191 19 <button class="copy-btn" onclick="copyText('TR93008290009491708319119')"><i class="fas fa-copy"></i></button></span>
        </div>
        <div class="iban-row">
          <span class="iban-label">A√ßƒ±klama</span>
          <span class="iban-val" id="aciklamaVal" style="color:var(--p);">Y√ºkleniyor... <button class="copy-btn" onclick="copyAciklama()"><i class="fas fa-copy"></i></button></span>
        </div>
      </div>

      <div class="sec-note">
        <i class="fas fa-info-circle"></i>
        <span>Havale a√ßƒ±klamasƒ±na <strong>ad soyadƒ±nƒ±zƒ± veya e-posta adresinizi</strong> yazƒ±n. Transfer yaptƒ±ktan sonra a≈üaƒüƒ±daki formu doldurun.</span>
      </div>

      <!-- TUTAR -->
      <div class="field">
        <div class="field-label"><i class="fas fa-turkish-lira"></i> G√∂nderdiƒüiniz Tutar</div>
        <input type="number" class="inp" id="balAmt" placeholder="√ñrn: 100" min="10" oninput="checkBalForm()">
        <div class="field-hint">Minimum: 10 ‚Ç∫</div>
      </div>

      <!-- ƒ∞≈ûLEM NO -->
      <div class="field">
        <div class="field-label"><i class="fas fa-receipt"></i> ƒ∞≈ülem / Referans Numarasƒ±</div>
        <input type="text" class="inp" id="balTxId" placeholder="Papara'dan gelen i≈ülem numarasƒ±" oninput="checkBalForm()">
        <div class="field-hint">Papara dekontundaki referans numarasƒ±nƒ± girin</div>
      </div>

      <button class="btn-pay" id="btnSendBal" onclick="sendBalanceRequest()" disabled>
        <i class="fas fa-paper-plane"></i> Talebi G√∂nder
      </button>
    </div>

    <!-- GE√áMƒ∞≈û -->
    <div class="hist-title"><i class="fas fa-history"></i> Bakiye Ge√ßmi≈üi</div>
    <div class="hist-box" id="histBox">
      <div class="hist-empty"><i class="fas fa-history"></i><p>Hen√ºz bakiye talebi yok</p></div>
    </div>
  </div>

  <footer>
    <div class="foot-in">
      <div class="foot-links">
        <a href="https://wa.me/447795203704" target="_blank" class="foot-link wa"><i class="fab fa-whatsapp"></i> WhatsApp</a>
        <a href="https://t.me/roxysatici" target="_blank" class="foot-link tg"><i class="fab fa-telegram"></i> Telegram</a>
      </div>
      <span class="foot-copy">¬© 2026 Roxy Store</span>
    </div>
  </footer>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
var _app=firebase.apps.length?firebase.apps[0]:firebase.initializeApp({apiKey:"AIzaSyBf2A1GhEzruI_6lfCNbq4MsbU8hxFjoqI",authDomain:"roxy-store-67c53.firebaseapp.com",projectId:"roxy-store-67c53",storageBucket:"roxy-store-67c53.firebasestorage.app",messagingSenderId:"450502544206",appId:"1:450502544206:web:502d0200dc35ecacfc2c1f"});
var auth=firebase.auth(),db=firebase.firestore();
var _user=null,_udata=null;

function formatPrice(n){return Math.round(n||0).toLocaleString('tr-TR')+' ‚Ç∫';}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('overlay').classList.toggle('active');}
function isWorking(){var n=new Date(),d=n.getDay(),h=n.getHours();return d===0||d===6||h>=17;}

var RoxyUI={
  toast:function(msg,type,dur){dur=dur||3500;var c={success:'#00FF88',error:'#FF6584',warning:'#FFB347',info:'#00D9FF'};var ic={success:'check-circle',error:'times-circle',warning:'exclamation-triangle',info:'info-circle'};var w=document.getElementById('_rt');if(!w){w=document.createElement('div');w.id='_rt';w.style.cssText='position:fixed;bottom:24px;right:24px;z-index:99999;display:flex;flex-direction:column;gap:10px;max-width:360px;';document.body.appendChild(w);}var t=document.createElement('div');t.style.cssText='display:flex;align-items:center;gap:12px;padding:14px 18px;background:#1F1F2E;border:1.5px solid '+(c[type]||c.info)+';border-radius:14px;font-family:Poppins,sans-serif;font-size:14px;color:#fff;box-shadow:0 8px 32px rgba(0,0,0,.5);';t.innerHTML='<i class="fas fa-'+(ic[type]||'info-circle')+'" style="color:'+(c[type]||c.info)+';font-size:18px;flex-shrink:0"></i><span>'+msg+'</span>';w.appendChild(t);setTimeout(function(){t.style.transition='.3s';t.style.opacity='0';t.style.transform='translateY(8px)';setTimeout(function(){t.remove();},300);},dur);},
  alert:function(title,msg,type){return new Promise(function(resolve){var ic={success:'check-circle',error:'times-circle',warning:'exclamation-triangle',info:'info-circle'};var c={success:'#00FF88',error:'#FF6584',warning:'#FFB347',info:'#00D9FF'};var ov=document.createElement('div');ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:99998;display:flex;align-items:center;justify-content:center;padding:16px;';ov.innerHTML='<div style="background:#1A1A28;border:1.5px solid rgba(0,217,255,.2);border-radius:20px;padding:36px 30px;max-width:420px;width:100%;text-align:center;font-family:Poppins,sans-serif;"><i class="fas fa-'+(ic[type||'info']||'info-circle')+'" style="font-size:48px;color:'+(c[type||'info']||c.info)+';display:block;margin-bottom:14px;"></i><div style="font-size:19px;font-weight:800;margin-bottom:10px;">'+title+'</div><div style="font-size:14px;color:#A0A0B8;line-height:1.7;margin-bottom:26px;">'+msg+'</div><button id="_rOk" style="padding:13px 40px;background:linear-gradient(135deg,#00D9FF,#A855F7);border:none;border-radius:12px;color:#0A0A0F;font-weight:800;font-size:15px;cursor:pointer;font-family:Poppins,sans-serif;">Tamam</button></div>';document.body.appendChild(ov);ov.querySelector('#_rOk').onclick=function(){ov.remove();resolve();};})}
};
function handleLogout(){RoxyUI.confirm('√áƒ±kƒ±≈ü Yap','Hesabƒ±nƒ±zdan √ßƒ±kƒ±≈ü yapmak istiyor musunuz?','√áƒ±kƒ±≈ü Yap','ƒ∞ptal',true).then(function(ok){if(ok)auth.signOut().then(function(){window.location.href='auth.html';});});}

var _unsub=auth.onAuthStateChanged(function(user){
  _unsub();
  if(!user){window.location.href='auth.html';return;}
  _user=user;
  db.collection('users').doc(user.uid).get().then(function(s){
    _udata=s.exists?s.data():{balance:0};
    var n=_udata.name||user.displayName||'Kullanƒ±cƒ±';
    document.getElementById('balDisplay').textContent=formatPrice(_udata.balance||0);
    document.getElementById('userAvatar').src='https://ui-avatars.com/api/?name='+encodeURIComponent(n)+'&background=00D9FF&color=fff';
    document.getElementById('userName').textContent=n;
    document.getElementById('aciklamaVal').innerHTML=(n)+' <button class="copy-btn" onclick="copyAciklama()"><i class="fas fa-copy"></i></button>';
    loadHistory(user.uid);
  });
});

function selectPapara(){
  document.getElementById('paparaCard').classList.add('selected');
  document.getElementById('paparaForm').classList.add('show');
  var w=isWorking(),sc=document.getElementById('schedBox');
  sc.className='sched '+(w?'ok':'off');
  document.getElementById('schedIco').innerHTML=w?'<i class="fas fa-check-circle"></i>':'<i class="fas fa-moon"></i>';
  document.getElementById('schedTitle').textContent=w?'Mesai Saatlerindeyiz':'Mesai Saati Dƒ±≈üƒ±';
  document.getElementById('schedText').innerHTML=w?'Onayƒ±nƒ±z genellikle <strong>15-30 dakika</strong> i√ßinde ger√ßekle≈üir.':'Talepler mesai saatinde onaylanƒ±r. <strong>Hafta i√ßi:</strong> 17:00‚Äì00:00 | <strong>Hafta sonu:</strong> 7/24';
  document.getElementById('paparaForm').scrollIntoView({behavior:'smooth',block:'nearest'});
}

function copyText(text){
  navigator.clipboard.writeText(text).then(function(){RoxyUI.toast('Kopyalandƒ±!','success',2000);}).catch(function(){RoxyUI.toast('Kopyalanamadƒ±','error',2000);});
}
function copyAciklama(){
  var name=_udata?(_udata.name||''):(_user?_user.email:'');
  copyText(name);
}

function checkBalForm(){
  var amt=parseInt(document.getElementById('balAmt').value)||0;
  var txId=(document.getElementById('balTxId').value||'').trim();
  document.getElementById('btnSendBal').disabled=!(amt>=10&&txId.length>=3);
}

function sendBalanceRequest(){
  var amt=parseInt(document.getElementById('balAmt').value)||0;
  var txId=(document.getElementById('balTxId').value||'').trim();
  if(amt<10||txId.length<3){RoxyUI.alert('Eksik Bilgi','L√ºtfen t√ºm alanlarƒ± doldurun.','warning');return;}
  var btn=document.getElementById('btnSendBal');
  btn.disabled=true; btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> G√∂nderiliyor...';
  var reqId='BAL-'+Date.now();
  db.collection('balance_requests').doc(reqId).set({
    requestId:reqId,userId:_user.uid,userEmail:_user.email,
    userName:(_udata&&_udata.name)?_udata.name:'',
    amount:amt,transactionId:txId,status:'pending',
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  }).then(function(){
    document.getElementById('balAmt').value='';
    document.getElementById('balTxId').value='';
    btn.disabled=true;btn.innerHTML='<i class="fas fa-paper-plane"></i> Talebi G√∂nder';
    RoxyUI.toast('‚úÖ Talebiniz alƒ±ndƒ±! Admin onayladƒ±ktan sonra bakiyeniz y√ºklenecektir.','success',6000);
    loadHistory(_user.uid);
  }).catch(function(e){
    btn.disabled=false;btn.innerHTML='<i class="fas fa-paper-plane"></i> Talebi G√∂nder';
    RoxyUI.alert('Hata','Talep g√∂nderilemedi: '+e.message,'error');
  });
}

function loadHistory(uid){
  var box=document.getElementById('histBox');
  db.collection('balance_requests').where('userId','==',uid).get()
    .then(function(snap){
      var docs=[]; snap.forEach(function(d){docs.push(d);}); 
      docs.sort(function(a,b){var ta=a.data().createdAt;var tb=b.data().createdAt;if(!ta||!tb)return 0;return tb.seconds-ta.seconds;});
      if(!docs.length){box.innerHTML='<div class="hist-empty"><i class="fas fa-history"></i><p>Hen√ºz bakiye talebi yok</p></div>';return;}
      var sm={pending:'‚è≥ Beklemede',approved:'‚úÖ Onaylandƒ±',rejected:'‚ùå Reddedildi'};
      var sc={pending:'#FFB347',approved:'#00FF88',rejected:'#FF6584'};
      var html='';
      docs.slice(0,10).forEach(function(d){
        var r=d.data();
        var dt=r.createdAt?r.createdAt.toDate().toLocaleDateString('tr-TR'):'‚Äî';
        html+='<div class="hist-row">'
          +'<div><div style="font-weight:700">'+formatPrice(r.amount)+'</div>'
          +'<div style="font-size:12px;color:var(--muted);margin-top:3px">ƒ∞≈ülem No: '+r.transactionId+'</div>'
          +'<div style="font-size:11px;color:var(--muted)">'+dt+'</div></div>'
          +'<div style="font-weight:700;color:'+sc[r.status]+'">'+(sm[r.status]||r.status)+'</div>'
          +'</div>';
      });
      box.innerHTML=html;
    }).catch(function(e){console.log(e);});
}
</script>
</body>
</html>
