<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Destek - Roxy Store</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap');
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
:root{--p:#00D9FF;--s:#A855F7;--g:#00FF88;--dark:#0A0A0F;--d2:#12121A;--d3:#1A1A28;--border:rgba(0,217,255,.12);--muted:#A0A0B8;--err:#FF6584;--warn:#FFB347;}
body{font-family:'Poppins',sans-serif;background:var(--dark);color:#fff;overflow-x:hidden;}
.sidebar{position:fixed;left:-280px;top:0;width:270px;height:100vh;background:rgba(26,26,40,.98);backdrop-filter:blur(24px);border-right:1px solid var(--border);z-index:1000;transition:left .3s;display:flex;flex-direction:column;}
.sidebar.open{left:0;}
.sb-head{padding:22px 20px;border-bottom:1px solid rgba(255,255,255,.05);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.logo{display:flex;align-items:center;gap:12px;}
.logo-icon{width:42px;height:42px;background:linear-gradient(135deg,var(--p),var(--s));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;color:#0A0A0F;}
.logo-main{font-size:22px;font-weight:900;background:linear-gradient(135deg,var(--p),var(--s));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.logo-sub{font-size:10px;font-weight:600;color:var(--muted);letter-spacing:2px;display:block;}
.sb-close{background:transparent;border:none;color:var(--muted);font-size:22px;cursor:pointer;padding:6px;}
.sb-nav{flex:1;overflow-y:auto;padding:12px 0;}
.nav-item{display:flex;align-items:center;gap:12px;padding:13px 20px;color:var(--muted);text-decoration:none;border-left:3px solid transparent;font-size:14px;font-weight:500;transition:.2s;cursor:pointer;}
.nav-item:hover,.nav-item.active{background:rgba(0,217,255,.07);color:var(--p);border-left-color:var(--p);}
.nav-item i{width:20px;font-size:17px;text-align:center;}
.nav-sep{height:1px;background:rgba(255,255,255,.06);margin:8px 16px;}
.nav-item.support{color:var(--p);font-weight:700;}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:999;opacity:0;visibility:hidden;transition:.3s;}
.overlay.active{opacity:1;visibility:visible;}
.main{min-height:100vh;display:flex;flex-direction:column;}
.topbar{background:rgba(26,26,40,.98);backdrop-filter:blur(24px);border-bottom:1px solid var(--border);padding:0 24px;height:68px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;}
.tb-left{display:flex;align-items:center;gap:14px;}
.menu-btn{background:transparent;border:none;color:#fff;font-size:22px;cursor:pointer;padding:8px;}
.tb-logo-text{font-size:18px;font-weight:900;background:linear-gradient(135deg,var(--p),var(--s));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.tb-logo-sub{font-size:10px;color:var(--muted);letter-spacing:1.5px;font-weight:600;}
.tb-right{display:flex;align-items:center;gap:14px;}
.bal-box{display:flex;align-items:center;gap:10px;padding:9px 14px;background:rgba(0,217,255,.07);border:1.5px solid rgba(0,217,255,.2);border-radius:12px;cursor:pointer;transition:.2s;}
.bal-box:hover{border-color:var(--p);}
.bal-box i{color:var(--p);font-size:18px;}
.bal-label{font-size:10px;color:var(--muted);display:block;text-transform:uppercase;letter-spacing:.5px;}
.bal-amount{font-size:15px;font-weight:800;color:var(--p);}
.user-box{display:flex;align-items:center;gap:8px;cursor:pointer;}
.user-box img{width:38px;height:38px;border-radius:50%;border:2px solid var(--p);}
.user-box span{font-weight:600;font-size:14px;}
/* VIEWS */
.view{display:none;flex:1;}
.view.show{display:flex;flex-direction:column;}
/* ANA EKRAN */
.content{flex:1;max-width:720px;width:100%;margin:0 auto;padding:36px 24px 60px;}
.page-hd{margin-bottom:28px;}
.page-hd h1{font-size:26px;font-weight:900;display:flex;align-items:center;gap:10px;margin-bottom:6px;}
.page-hd h1 i{color:var(--p);}
.page-hd p{color:var(--muted);}
.btn-new-ticket{width:100%;display:flex;align-items:center;justify-content:space-between;padding:20px 22px;background:linear-gradient(135deg,rgba(0,217,255,.12),rgba(168,85,247,.12));border:1.5px solid rgba(0,217,255,.25);border-radius:18px;color:#fff;cursor:pointer;font-family:'Poppins',sans-serif;text-align:left;margin-bottom:24px;transition:.2s;}
.btn-new-ticket:hover{border-color:var(--p);transform:translateY(-1px);}
.btn-new-left{display:flex;align-items:center;gap:16px;}
.new-ico{width:46px;height:46px;background:linear-gradient(135deg,var(--p),var(--s));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#0A0A0F;flex-shrink:0;}
.btn-new-title{font-size:15px;font-weight:700;display:block;margin-bottom:3px;}
.btn-new-sub{font-size:13px;color:var(--muted);}
.tickets-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.tickets-hd h3{font-size:17px;font-weight:700;display:flex;align-items:center;gap:8px;}
.tickets-hd h3 i{color:var(--p);}
.ticket-count{font-size:12px;color:var(--muted);background:rgba(255,255,255,.06);padding:4px 10px;border-radius:20px;}
.ticket-item{background:var(--d3);border:1.5px solid var(--border);border-radius:14px;padding:18px 20px;margin-bottom:10px;cursor:pointer;transition:.2s;}
.ticket-item:hover{border-color:rgba(0,217,255,.25);transform:translateY(-1px);}
.tkt-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.tkt-id{font-size:12px;color:var(--p);font-weight:700;}
.tkt-badge{font-size:11px;padding:3px 8px;border-radius:6px;display:flex;align-items:center;gap:5px;font-weight:700;}
.badge-open{background:rgba(0,255,136,.15);color:var(--g);}
.badge-closed{background:rgba(255,255,255,.07);color:var(--muted);}
.tkt-title{font-size:14px;font-weight:600;margin-bottom:4px;}
.tkt-date{font-size:12px;color:var(--muted);}
.empty{text-align:center;padding:50px 20px;color:var(--muted);}
.empty i{font-size:42px;opacity:.25;display:block;margin-bottom:12px;}
/* YENİ TALEp */
.form-card{background:var(--d3);border:1.5px solid var(--border);border-radius:20px;padding:28px;}
.field{margin-bottom:18px;}
.field-label{font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:flex;align-items:center;gap:8px;margin-bottom:10px;}
.field-label i{color:var(--p);}
.inp,.txtarea,.sel-inp{width:100%;padding:14px 16px;background:var(--d2);border:1.5px solid rgba(255,255,255,.08);border-radius:12px;color:#fff;font-family:'Poppins',sans-serif;font-size:14px;outline:none;transition:border .2s;resize:vertical;}
.sel-inp{appearance:none;cursor:pointer;}
.inp:focus,.txtarea:focus,.sel-inp:focus{border-color:var(--p);}
.char-cnt{font-size:11px;color:var(--muted);text-align:right;margin-top:4px;}
.btn-submit{width:100%;display:flex;align-items:center;justify-content:center;gap:10px;padding:16px;background:linear-gradient(135deg,var(--p),var(--s));border:none;border-radius:13px;color:#0A0A0F;font-family:'Poppins',sans-serif;font-weight:800;font-size:16px;cursor:pointer;transition:.2s;margin-top:4px;}
.btn-submit:hover:not(:disabled){transform:translateY(-1px);}
.btn-submit:disabled{opacity:.35;cursor:not-allowed;}
/* CHAT */
.chat-header{background:rgba(26,26,40,.98);border-bottom:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;gap:14px;position:sticky;top:0;z-index:10;}
.btn-back{background:transparent;border:none;color:var(--p);font-size:20px;cursor:pointer;padding:6px;border-radius:8px;}
.btn-back:hover{background:rgba(0,217,255,.08);}
.chat-title{font-size:15px;font-weight:700;flex:1;}
.chat-sub{font-size:12px;color:var(--muted);}
.chat-status{font-size:12px;padding:4px 10px;border-radius:20px;font-weight:700;}
.st-open{background:rgba(0,255,136,.15);color:var(--g);}
.st-closed{background:rgba(255,255,255,.07);color:var(--muted);}
.chat-msgs{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:12px;min-height:300px;max-height:calc(100vh - 280px);}
.msg{display:flex;flex-direction:column;max-width:78%;}
.msg.user{align-self:flex-end;align-items:flex-end;}
.msg.admin{align-self:flex-start;align-items:flex-start;}
.msg-bubble{padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.6;word-break:break-word;}
.msg.user .msg-bubble{background:linear-gradient(135deg,rgba(0,217,255,.2),rgba(168,85,247,.2));border:1.5px solid rgba(0,217,255,.2);}
.msg.admin .msg-bubble{background:var(--d3);border:1.5px solid var(--border);}
.msg-time{font-size:11px;color:var(--muted);margin-top:4px;padding:0 4px;}
.chat-inp-area{border-top:1px solid var(--border);padding:14px 16px;background:rgba(26,26,40,.98);}
.chat-inp-wrap{display:flex;align-items:flex-end;gap:10px;}
.chat-textarea{flex:1;padding:12px 14px;background:var(--d2);border:1.5px solid rgba(255,255,255,.08);border-radius:12px;color:#fff;font-family:'Poppins',sans-serif;font-size:14px;outline:none;resize:none;max-height:120px;transition:border .2s;}
.chat-textarea:focus{border-color:var(--p);}
.chat-send{width:44px;height:44px;background:linear-gradient(135deg,var(--p),var(--s));border:none;border-radius:12px;color:#0A0A0F;font-size:17px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:.2s;}
.chat-send:hover{opacity:.9;}
.chat-send:disabled{opacity:.35;cursor:not-allowed;}
.closed-notice{text-align:center;padding:12px;font-size:13px;color:var(--muted);display:flex;align-items:center;justify-content:center;gap:8px;}
.back-hd{display:flex;align-items:center;gap:14px;padding:16px 0;margin-bottom:20px;}
.back-hd h2{font-size:20px;font-weight:800;}
footer{background:var(--d3);border-top:1px solid var(--border);padding:22px 24px;}
.foot-in{max-width:720px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;}
.foot-links{display:flex;gap:10px;}
.foot-link{display:flex;align-items:center;gap:6px;padding:8px 14px;border-radius:8px;text-decoration:none;font-size:13px;font-weight:600;color:#fff;}
.foot-link.wa{background:#25D366;}.foot-link.tg{background:#0088CC;}
.foot-copy{color:var(--muted);font-size:13px;}
@media(max-width:768px){.user-box span,.bal-label{display:none;}.content{padding:20px 14px;}}
</style>
</head>
<body>

<div class="sidebar" id="sidebar">
  <div class="sb-head">
    <div class="logo"><div class="logo-icon"><i class="fas fa-bolt"></i></div><div><span class="logo-main">ROXY</span><span class="logo-sub">STORE</span></div></div>
    <button class="sb-close" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
  </div>
  <nav class="sb-nav">
    <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i><span>Ana Sayfa</span></a>
    <a href="virtual-number.html" class="nav-item"><i class="fas fa-mobile-alt"></i><span>Sanal Numara</span></a>
    <a href="social-media.html" class="nav-item"><i class="fas fa-chart-line"></i><span>Sosyal Medya</span></a>
    <a href="balance.html" class="nav-item"><i class="fas fa-wallet"></i><span>Bakiye Ekle</span></a>
    <a href="reviews.html" class="nav-item"><i class="fas fa-star"></i><span>Değerlendirmeler</span></a>
    <div class="nav-sep"></div>
    <a href="support.html" class="nav-item support active"><i class="fas fa-headset"></i><span>Destek</span></a>
    <a href="profile.html" class="nav-item"><i class="fas fa-user-circle"></i><span>Profil</span></a>
    <div class="nav-item" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i><span>Çıkış Yap</span></div>
  </nav>
</div>
<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

<div class="main" id="mainWrap">
  <div class="topbar">
    <div class="tb-left">
      <button class="menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
      <div><span class="tb-logo-text">ROXY</span> <span class="tb-logo-sub">STORE</span></div>
    </div>
    <div class="tb-right">
      <div class="bal-box" onclick="window.location.href='balance.html'">
        <i class="fas fa-wallet"></i>
        <div><span class="bal-label">Bakiye</span><span class="bal-amount" id="balDisplay">0 ₺</span></div>
      </div>
      <div class="user-box" onclick="window.location.href='profile.html'">
        <img id="userAvatar" src="https://ui-avatars.com/api/?name=U&background=00D9FF&color=fff" alt="">
        <span id="userName">Kullanıcı</span>
      </div>
    </div>
  </div>

  <!-- ANA EKRAN -->
  <div class="view show" id="mainView">
    <div class="content">
      <div class="page-hd">
        <h1><i class="fas fa-headset"></i> Destek</h1>
        <p>Destek taleplerinizi oluşturun ve takip edin</p>
      </div>
      <button class="btn-new-ticket" onclick="showNewTicket()">
        <div class="btn-new-left">
          <div class="new-ico"><i class="fas fa-plus"></i></div>
          <div><span class="btn-new-title">Yeni Talep Oluştur</span><span class="btn-new-sub">Destek ekibimizle iletişime geçin</span></div>
        </div>
        <i class="fas fa-chevron-right"></i>
      </button>
      <div class="tickets-hd">
        <h3><i class="fas fa-list-alt"></i> Taleplerim</h3>
        <span class="ticket-count" id="tktCount">0 talep</span>
      </div>
      <div id="ticketsList"><div class="empty"><i class="fas fa-headset"></i><p>Henüz destek talebiniz yok</p></div></div>
    </div>
    <footer><div class="foot-in"><div class="foot-links"><a href="https://wa.me/447795203704" target="_blank" class="foot-link wa"><i class="fab fa-whatsapp"></i> WhatsApp</a><a href="https://t.me/roxysatici" target="_blank" class="foot-link tg"><i class="fab fa-telegram"></i> Telegram</a></div><span class="foot-copy">© 2026 Roxy Store</span></div></footer>
  </div>

  <!-- YENİ TALEP -->
  <div class="view" id="newView">
    <div class="content">
      <div class="back-hd">
        <button class="btn-back" onclick="showMain()"><i class="fas fa-arrow-left"></i></button>
        <h2>Yeni Talep Oluştur</h2>
      </div>
      <div class="form-card">
        <div class="field">
          <div class="field-label"><i class="fas fa-tag"></i> Başlık</div>
          <input type="text" class="inp" id="tktTitle" placeholder="Talebinizin başlığı" maxlength="100" oninput="checkTktForm();document.getElementById('titleCnt').textContent=this.value.length+'/100'">
          <div class="char-cnt" id="titleCnt">0/100</div>
        </div>
        <div class="field">
          <div class="field-label"><i class="fas fa-tag"></i> Kategori</div>
          <select class="sel-inp" id="tktCat" onchange="checkTktForm()">
            <option value="">— Seçin —</option>
            <option value="Sanal Numara">Sanal Numara</option>
            <option value="Sosyal Medya">Sosyal Medya</option>
            <option value="Bakiye">Bakiye</option>
            <option value="Teknik Sorun">Teknik Sorun</option>
            <option value="Diğer">Diğer</option>
          </select>
        </div>
        <div class="field">
          <div class="field-label"><i class="fas fa-align-left"></i> Mesajınız</div>
          <textarea class="txtarea" id="tktMsg" placeholder="Sorununuzu detaylı açıklayın..." rows="6" maxlength="1000" oninput="checkTktForm();document.getElementById('msgCnt').textContent=this.value.length+'/1000'"></textarea>
          <div class="char-cnt" id="msgCnt">0/1000</div>
        </div>
        <div style="background:rgba(0,217,255,.06);border:1px solid rgba(0,217,255,.12);border-radius:10px;padding:12px 14px;font-size:12px;color:var(--muted);display:flex;align-items:center;gap:8px;margin-bottom:18px;">
          <i class="fas fa-clock" style="color:var(--p)"></i>
          Mesai: <strong style="color:#fff">Hafta içi 17:00–00:00</strong> | <strong style="color:#fff">Hafta sonu 7/24</strong>
        </div>
        <button class="btn-submit" id="btnSendTkt" onclick="submitTicket()" disabled>
          <i class="fas fa-paper-plane"></i> Talebi Gönder
        </button>
      </div>
    </div>
  </div>

  <!-- CHAT -->
  <div class="view" id="chatView" style="height:100vh;overflow:hidden;">
    <div class="chat-header" style="background:rgba(26,26,40,.98);border-bottom:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;gap:14px;">
      <button class="btn-back" onclick="showMain()"><i class="fas fa-arrow-left"></i></button>
      <div style="flex:1">
        <div class="chat-title" id="chatTitle">—</div>
        <div class="chat-sub" id="chatSub">—</div>
      </div>
      <span class="chat-status" id="chatStatus"></span>
    </div>
    <div class="chat-msgs" id="chatMsgs"></div>
    <div class="chat-inp-area" id="chatInpArea">
      <div class="chat-inp-wrap">
        <textarea class="chat-textarea" id="chatInp" placeholder="Mesajınızı yazın..." rows="1" oninput="autoResize(this)"></textarea>
        <button class="chat-send" id="chatSendBtn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
    <div class="closed-notice" id="closedNotice" style="display:none;"><i class="fas fa-lock"></i> Bu talep kapatılmıştır.</div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
var _app=firebase.apps.length?firebase.apps[0]:firebase.initializeApp({apiKey:"AIzaSyBf2A1GhEzruI_6lfCNbq4MsbU8hxFjoqI",authDomain:"roxy-store-67c53.firebaseapp.com",projectId:"roxy-store-67c53",storageBucket:"roxy-store-67c53.firebasestorage.app",messagingSenderId:"450502544206",appId:"1:450502544206:web:502d0200dc35ecacfc2c1f"});
var auth=firebase.auth(),db=firebase.firestore();
var _user=null,_udata=null,_curTktId=null;

function formatPrice(n){return Math.round(n||0).toLocaleString('tr-TR')+' ₺';}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('overlay').classList.toggle('active');}

var RoxyUI={
  toast:function(msg,type,dur){dur=dur||3500;var c={success:'#00FF88',error:'#FF6584',warning:'#FFB347',info:'#00D9FF'};var ic={success:'check-circle',error:'times-circle',warning:'exclamation-triangle',info:'info-circle'};var w=document.getElementById('_rt');if(!w){w=document.createElement('div');w.id='_rt';w.style.cssText='position:fixed;bottom:24px;right:24px;z-index:99999;display:flex;flex-direction:column;gap:10px;max-width:360px;';document.body.appendChild(w);}var t=document.createElement('div');t.style.cssText='display:flex;align-items:center;gap:12px;padding:14px 18px;background:#1F1F2E;border:1.5px solid '+(c[type]||c.info)+';border-radius:14px;font-family:Poppins,sans-serif;font-size:14px;color:#fff;box-shadow:0 8px 32px rgba(0,0,0,.5);';t.innerHTML='<i class="fas fa-'+(ic[type]||'info-circle')+'" style="color:'+(c[type]||c.info)+';font-size:18px;flex-shrink:0"></i><span>'+msg+'</span>';w.appendChild(t);setTimeout(function(){t.style.transition='.3s';t.style.opacity='0';t.style.transform='translateY(8px)';setTimeout(function(){t.remove();},300);},dur);},
  alert:function(title,msg,type){return new Promise(function(resolve){var ic={success:'check-circle',error:'times-circle',warning:'exclamation-triangle',info:'info-circle'};var c={success:'#00FF88',error:'#FF6584',warning:'#FFB347',info:'#00D9FF'};var ov=document.createElement('div');ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:99998;display:flex;align-items:center;justify-content:center;padding:16px;';ov.innerHTML='<div style="background:#1A1A28;border:1.5px solid rgba(0,217,255,.2);border-radius:20px;padding:36px 30px;max-width:420px;width:100%;text-align:center;font-family:Poppins,sans-serif;"><i class="fas fa-'+(ic[type||'info']||'info-circle')+'" style="font-size:48px;color:'+(c[type||'info']||c.info)+';display:block;margin-bottom:14px;"></i><div style="font-size:19px;font-weight:800;margin-bottom:10px;">'+title+'</div><div style="font-size:14px;color:#A0A0B8;line-height:1.7;margin-bottom:26px;">'+msg+'</div><button id="_rOk" style="padding:13px 40px;background:linear-gradient(135deg,#00D9FF,#A855F7);border:none;border-radius:12px;color:#0A0A0F;font-weight:800;font-size:15px;cursor:pointer;font-family:Poppins,sans-serif;">Tamam</button></div>';document.body.appendChild(ov);ov.querySelector('#_rOk').onclick=function(){ov.remove();resolve();};});}
};
function handleLogout(){auth.signOut().then(function(){window.location.href='auth.html';});}

function showView(id){document.querySelectorAll('.view').forEach(function(v){v.classList.remove('show');});document.getElementById(id).classList.add('show');}
function showMain(){showView('mainView');_curTktId=null;loadTickets(_user.uid);}
function showNewTicket(){showView('newView');}

var _unsub=auth.onAuthStateChanged(function(user){
  _unsub();
  if(!user){window.location.href='auth.html';return;}
  _user=user;
  db.collection('users').doc(user.uid).get().then(function(s){
    _udata=s.exists?s.data():{balance:0};
    var n=_udata.name||user.displayName||'Kullanıcı';
    document.getElementById('balDisplay').textContent=formatPrice(_udata.balance||0);
    document.getElementById('userAvatar').src='https://ui-avatars.com/api/?name='+encodeURIComponent(n)+'&background=00D9FF&color=fff';
    document.getElementById('userName').textContent=n;
    loadTickets(user.uid);
  });
});

function loadTickets(uid){
  db.collection('tickets').where('userId','==',uid).get()
    .then(function(snap){
      var docs=[]; snap.forEach(function(d){docs.push(d);}); 
      docs.sort(function(a,b){var ta=a.data().createdAt;var tb=b.data().createdAt;if(!ta||!tb)return 0;return tb.seconds-ta.seconds;});
      document.getElementById('tktCount').textContent=docs.length+' talep';
      if(!docs.length){document.getElementById('ticketsList').innerHTML='<div class="empty"><i class="fas fa-headset"></i><p>Henüz destek talebiniz yok</p></div>';return;}
      var html='';
      docs.forEach(function(doc){
        var t=doc.data(),isOpen=t.status==='open';
        var dt=t.createdAt?t.createdAt.toDate().toLocaleDateString('tr-TR'):'—';
        html+='<div class="ticket-item" onclick="openChat(\''+doc.id+'\')">'
          +'<div class="tkt-top"><span class="tkt-id">'+(t.ticketId||doc.id)+'</span>'
          +'<span class="tkt-badge '+(isOpen?'badge-open':'badge-closed')+'">'
          +'<i class="fas fa-circle" style="font-size:8px"></i> '+(isOpen?'Açık':'Kapalı')+'</span></div>'
          +'<div class="tkt-title">'+t.title+'</div>'
          +'<div class="tkt-date">'+dt+'</div>'
          +'</div>';
      });
      document.getElementById('ticketsList').innerHTML=html;
    }).catch(function(e){console.log(e);});
}

function checkTktForm(){
  var t=(document.getElementById('tktTitle').value||'').trim();
  var c=(document.getElementById('tktCat').value||'').trim();
  var m=(document.getElementById('tktMsg').value||'').trim();
  document.getElementById('btnSendTkt').disabled=!(t.length>=3&&c&&m.length>=10);
}

function submitTicket(){
  var title=(document.getElementById('tktTitle').value||'').trim();
  var cat=(document.getElementById('tktCat').value||'').trim();
  var msg=(document.getElementById('tktMsg').value||'').trim();
  if(!title||!cat||!msg){RoxyUI.alert('Eksik','Lütfen tüm alanları doldurun.','warning');return;}
  var btn=document.getElementById('btnSendTkt');
  btn.disabled=true;btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Gönderiliyor...';

  db.collection('tickets').where('userId','==',_user.uid).get().then(function(snap){
    var count=snap.size+1;
    var d=new Date(),p=function(n){return String(n).padStart(2,'0');};
    var tktId='TKT-'+p(d.getDate())+p(d.getMonth()+1)+d.getFullYear()+'-'+String(count).padStart(4,'0');
    return db.collection('tickets').doc(tktId).set({
      ticketId:tktId,userId:_user.uid,userEmail:_user.email,
      userName:(_udata&&_udata.name)?_udata.name:'',
      title:title,category:cat,status:'open',
      messages:[{sender:'user',text:msg,timestamp:new Date().toISOString()}],
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });
  }).then(function(){
    document.getElementById('tktTitle').value='';
    document.getElementById('tktCat').value='';
    document.getElementById('tktMsg').value='';
    document.getElementById('titleCnt').textContent='0/100';
    document.getElementById('msgCnt').textContent='0/1000';
    btn.disabled=true;btn.innerHTML='<i class="fas fa-paper-plane"></i> Talebi Gönder';
    RoxyUI.toast('✅ Talebiniz oluşturuldu!','success',4000);
    showMain();
  }).catch(function(e){
    btn.disabled=false;btn.innerHTML='<i class="fas fa-paper-plane"></i> Talebi Gönder';
    RoxyUI.alert('Hata','Talep oluşturulamadı: '+e.message,'error');
  });
}

function openChat(docId){
  _curTktId=docId;
  showView('chatView');
  db.collection('tickets').doc(docId).get().then(function(s){
    var t=s.data();
    document.getElementById('chatTitle').textContent=t.title;
    document.getElementById('chatSub').textContent=(t.ticketId||docId)+' · '+t.category;
    var isOpen=t.status==='open';
    var stEl=document.getElementById('chatStatus');
    stEl.textContent=isOpen?'Açık':'Kapalı';
    stEl.className='chat-status '+(isOpen?'st-open':'st-closed');
    document.getElementById('chatInpArea').style.display=isOpen?'block':'none';
    document.getElementById('closedNotice').style.display=isOpen?'none':'flex';
    renderMsgs(t.messages||[]);
  }).catch(function(e){console.log(e);});
}

function renderMsgs(msgs){
  var box=document.getElementById('chatMsgs');
  if(!msgs.length){box.innerHTML='<div class="empty"><i class="fas fa-comments"></i><p>Henüz mesaj yok</p></div>';return;}
  box.innerHTML=msgs.map(function(m){
    var isUser=m.sender==='user';
    var time=m.timestamp?new Date(m.timestamp).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'}):'';
    return '<div class="msg '+(isUser?'user':'admin')+'">'
      +'<div class="msg-bubble">'+m.text+'</div>'
      +'<div class="msg-time">'+(isUser?'Siz':'Roxy Destek')+' · '+time+'</div>'
      +'</div>';
  }).join('');
  box.scrollTop=box.scrollHeight;
}

function sendMsg(){
  if(!_curTktId)return;
  var inp=document.getElementById('chatInp');
  var text=(inp.value||'').trim();
  if(!text)return;
  inp.value='';inp.style.height='auto';
  var msg={sender:'user',text:text,timestamp:new Date().toISOString()};
  db.collection('tickets').doc(_curTktId).update({
    messages:firebase.firestore.FieldValue.arrayUnion(msg)
  }).then(function(){
    return db.collection('tickets').doc(_curTktId).get();
  }).then(function(s){
    renderMsgs(s.data().messages||[]);
  }).catch(function(e){console.log(e);});
}

function autoResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px';}
document.getElementById('chatInp').addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}});
</script>
</body>
</html>
